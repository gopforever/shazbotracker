<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CardTracker — Sports Cards & TCG Inventory</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0d12;          /* page background */
      --panel:#121625;       /* panels/cards */
      --panel-2:#0f1320;     /* darker panel */
      --muted:#9fb0c2;       /* secondary text */
      --text:#e8f0fb;        /* primary text */
      --brand:#6aa2ff;       /* brand accent */
      --brand-2:#7ef0ff;     /* brand accent 2 */
      --good:#1dd1a1;        /* profit */
      --warn:#ffb85c;        /* warning */
      --bad:#ff6b6b;         /* loss */
      --border:rgba(255,255,255,.08);
      --shadow:0 10px 24px rgba(2,12,27,.35), 0 2px 6px rgba(2,12,27,.25);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 85% -10%, #14203f 0%, transparent 60%),
                  radial-gradient(900px 600px at -10% -20%, #18335e 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.45;
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg, rgba(12,16,28,.9), rgba(12,16,28,.6));
      border-bottom:1px solid var(--border);
    }
    .nav{max-width:1200px; margin:0 auto; padding:14px 18px; display:flex; gap:12px; align-items:center;}
    .logo{
      display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px;
      background:linear-gradient(90deg,var(--brand),var(--brand-2)); -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .logo .dot{width:10px; height:10px; border-radius:50%; background:linear-gradient(45deg,var(--brand),var(--brand-2)); box-shadow:0 0 16px var(--brand)}
    .pill{padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:var(--panel); color:var(--text)}
    .ghost{background:transparent}
    .primary{background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#041429; border:none; box-shadow:var(--shadow);}
    .btn{display:inline-flex; align-items:center; gap:8px; cursor:pointer; font-weight:600}
    .btn svg{width:16px; height:16px}

    main{max-width:1200px; margin:22px auto; padding:0 18px; display:grid; gap:18px}

    .panel{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}

    .search{padding:14px; display:grid; gap:12px}
    .search-row{display:grid; grid-template-columns: 1fr auto auto auto; gap:10px}
    .search input[type="text"]{
      width:100%; padding:14px 14px; border-radius:12px; border:1px solid var(--border); background:var(--panel-2); color:var(--text);
      outline: none; box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
    }
    .help{font-size:12px; color:var(--muted)}

    .results{padding:8px 8px 12px; display:grid; gap:8px; max-height:280px; overflow:auto}
    .result{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--panel-2)}
    .result small{color:var(--muted)}

    .grid{display:grid; gap:16px}
    .two{grid-template-columns: 1.25fr .75fr}
    @media (max-width:1000px){ .two{grid-template-columns:1fr} }

    .inventory{padding:12px}
    .table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px}
    table{width:100%; border-collapse:separate; border-spacing:0; min-width:1000px;}
    thead th{position:sticky; top:0; background:linear-gradient(180deg, #141a2c, #11162a); text-align:left; font-weight:600; padding:10px 12px; border-bottom:1px solid var(--border)}
    tbody td{padding:10px 12px; border-bottom:1px solid var(--border)}
    tbody tr:hover{background:rgba(255,255,255,.02)}

    select, input[type="number"], input[type="text"].row-input{
      background:var(--panel-2); border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:8px; width:100%; outline:none
    }

    .money{font-variant-numeric: tabular-nums; font-feature-settings: "tnum"}
    .delta-pos{color:var(--good); font-weight:600}
    .delta-neg{color:var(--bad); font-weight:600}

    .footer{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:8px; color:var(--muted)}
    .totals{display:flex; gap:10px; flex-wrap:wrap}
    .totals .chip{background:var(--panel-2); border:1px solid var(--border); padding:8px 12px; border-radius:999px}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    label.file{position:relative}
    input[type=file]{position:absolute; inset:0; opacity:0; cursor:pointer}

    .notice{padding:12px; border:1px dashed var(--border); border-radius:12px; color:var(--muted)}
    .muted{color:var(--muted)}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; background:#0a0e18; border:1px solid var(--border); padding:2px 6px; border-radius:6px}

    .tag{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:var(--panel-2); color:var(--muted)}

    a{color:var(--brand-2)}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo"><span class="dot"></span> CardTracker</div>
      <div class="toolbar" style="margin-left:auto">
        <button id="btn-export" class="btn pill"><svg viewBox="0 0 24 24" fill="none"><path d="M12 3v12m0 0l-4-4m4 4l4-4M4 15v4a2 2 0 002 2h12a2 2 0 002-2v-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" /></svg>Export CSV</button>
        <button id="btn-export-json" class="btn pill">Export JSON</button>
        <label class="btn pill" id="btn-import">Import CSV<input type="file" accept=".csv" /></label>
        <button id="btn-refresh" class="btn pill">Refresh Prices</button>
        <button id="btn-clear" class="btn pill ghost" title="Clears local data only">Clear Data</button>
      </div>
    </div>
  </header>

  <main>
    <section class="panel search">
      <div class="search-row">
        <input id="q" type="text" placeholder="Search cards by player, set, year, number… (e.g., ‘Michael Jordan 1986 Fleer #57’)" />
        <button id="btn-search" class="btn primary pill">Search</button>
        <select id="source" class="pill" title="Choose data source">
          <option value="scp" selected>SportsCardsPro</option>
          <option value="pc">PriceCharting (for TCG)</option>
        </select>
        <span class="tag" id="planTag" title="API access runs from your token">API: Token</span>
      </div>
      <div class="help">Tip: add results straight to your inventory. We’ll fetch live prices by condition. CORS is enabled by SportsCardsPro.</div>
      <div class="results" id="results"></div>
    </section>

    <section class="grid two">
      <div class="panel inventory">
        <div class="footer" style="margin-bottom:8px">
          <div class="totals">
            <div class="chip">Items: <strong id="totalItems">0</strong></div>
            <div class="chip">Qty: <strong id="totalQty">0</strong></div>
            <div class="chip">Est. Value: <strong class="money" id="totalValue">$0.00</strong></div>
            <div class="chip">Cost Basis: <strong class="money" id="totalCost">$0.00</strong></div>
            <div class="chip">PnL: <strong class="money" id="totalPnL">$0.00</strong></div>
          </div>
          <div class="muted">Values fetched live & cached locally <span class="kbd">localStorage</span></div>
        </div>

        <div class="table-wrap">
          <table id="table">
            <thead>
              <tr>
                <th style="width:30px"></th>
                <th>Card</th>
                <th>Set</th>
                <th>Condition</th>
                <th>Qty</th>
                <th>Unit Cost</th>
                <th>Est. Price</th>
                <th>Est. Value</th>
                <th>PnL</th>
                <th>Notes</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="footer">
          <div class="muted">Condition maps to API price keys automatically (e.g., <span class="kbd">Ungraded → loose-price</span>, <span class="kbd">PSA 10 → psa10-price/manual-only-price</span>).</div>
          <div class="toolbar">
            <button class="btn pill" id="btn-add-manual">Add Manual Item</button>
          </div>
        </div>
      </div>

      <div class="panel" style="padding:12px">
        <h3 style="margin:4px 6px 10px">How to use</h3>
        <div class="notice">
          <ol style="margin:0 0 0 18px; padding:0; display:grid; gap:8px">
            <li>Use the search box to find a card. Click <em>Add</em> to insert it into your inventory.</li>
            <li>Pick a <strong>Condition</strong>, set <strong>Qty</strong> and optional <strong>Unit Cost</strong>. Prices update live.</li>
            <li>Click <strong>Refresh Prices</strong> to update all items. We cache responses for speed.</li>
            <li>Import or Export your data via CSV at any time. A JSON export is also available.</li>
          </ol>
          <p class="muted" style="margin-top:10px">Security note: front‑end requests expose your token. For production, proxy requests via a serverless function. See inline comments in the source.</p>
          <p style="margin-top:12px"><button class="btn pill" id="btn-template">Download Sample CSV</button></p>
        </div>
        <div style="margin-top:14px">
          <h4 style="margin:0 0 6px">Supported Conditions</h4>
          <div class="muted">Ungraded, PSA 10/9, BGS 10, SGC 10, CGC 10, Graded 8/7. We auto‑detect keys like <span class="kbd">psa10-price</span>, <span class="kbd">manual-only-price</span>, <span class="kbd">graded-price</span>, etc.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
  /*** 
   * CardTracker — Single-file inventory app
   * Data: LocalStorage
   * Pricing: SportsCardsPro (and PriceCharting fallback for TCG)
   * Token Note: Exposing tokens client-side is insecure.
   *   For production, create a tiny proxy (e.g., Netlify/Cloudflare function) that injects the token server-side.
   *   Example code is included below as a comment.
   */

  // ====== CONFIG ======
  const API_TOKEN = "60a3ec136eda14138bf7b4f236bcfbc584262a54"; // Provided token — replace if needed
  const API_BASE = {
    scp: "https://www.sportscardspro.com",     // Sports cards
    pc:  "https://www.pricecharting.com"       // PriceCharting (TCG like Pokemon/MTG/YGO)
  };

  // Rate-limit concurrent fetches for refreshes
  const MAX_CONCURRENCY = 3;

  // ====== STATE ======
  const state = {
    source: localStorage.getItem('ct_source') || 'scp',
    items: [],           // inventory rows
    priceCache: {},      // id -> full product payload
  };

  // Load saved state
  (()=>{
    try{
      const saved = JSON.parse(localStorage.getItem('ct_items')||'[]');
      state.items = saved;
      const cache = JSON.parse(localStorage.getItem('ct_priceCache')||'{}');
      state.priceCache = cache;
      const src = localStorage.getItem('ct_source'); if(src) state.source = src;
    }catch(e){ console.warn('No saved data'); }
  })();

  // ====== DOM HELPERS ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmt = n => (isFinite(n)? (n<0? `-$${(Math.abs(n)/100).toFixed(2)}` : `$${(n/100).toFixed(2)}`) : '$0.00');
  const moneyToCents = s => Math.round(parseFloat(String(s||0)) * 100);
  const cents = n => Math.round(n);
  const nowStr = () => new Date().toLocaleString();

  // ====== API LAYER ======
  async function apiSearchProducts(query, source){
    const base = API_BASE[source];
    const url = new URL(base + '/api/products');
    url.searchParams.set('t', API_TOKEN);
    url.searchParams.set('q', query);
    const res = await fetch(url, {mode:'cors'});
    const data = await res.json();
    if(data.status !== 'success') throw new Error(data['error-message']||'Search failed');
    return data.products || [];
  }

  async function apiGetProductById(id, source){
    const base = API_BASE[source];
    const url = new URL(base + '/api/product');
    url.searchParams.set('t', API_TOKEN);
    url.searchParams.set('id', id);
    const res = await fetch(url, {mode:'cors'});
    const data = await res.json();
    if(data.status !== 'success') throw new Error(data['error-message']||'Lookup failed');
    return data;
  }

  // ====== PRICING MAPPER ======
  const CONDITION_OPTIONS = [
    'Ungraded','PSA 10','PSA 9','BGS 10','SGC 10','CGC 10','Graded 8','Graded 7'
  ];

  function pickPriceCents(productPayload, condition){
    // Keys vary a bit by catalog. Try to intelligently pick a matching price field.
    const keys = Object.keys(productPayload||{});

    const findKey = (parts) => keys.find(k => parts.every(p => k.toLowerCase().includes(p)));
    const has = (k) => keys.includes(k);

    switch(condition){
      case 'Ungraded':
        if(has('loose-price')) return cents(productPayload['loose-price']);
        if(has('ungraded-price')) return cents(productPayload['ungraded-price']);
        break;
      case 'PSA 10':
        // Some guides use psa10-price, some store PSA10 under manual-only-price
        if(findKey(['psa','10','price'])) return cents(productPayload[findKey(['psa','10','price'])]);
        if(has('manual-only-price')) return cents(productPayload['manual-only-price']);
        break;
      case 'PSA 9':
        if(findKey(['psa','9','price'])) return cents(productPayload[findKey(['psa','9','price'])]);
        if(has('graded-price')) return cents(productPayload['graded-price']); // generic graded (9)
        break;
      case 'BGS 10':
        if(findKey(['bgs','10','price'])) return cents(productPayload[findKey(['bgs','10','price'])]);
        if(findKey(['bgs','black','label'])) return cents(productPayload[findKey(['bgs','black','label'])]);
        break;
      case 'SGC 10':
        if(findKey(['sgc','10','price'])) return cents(productPayload[findKey(['sgc','10','price'])]);
        if(findKey(['condition','18','price'])) return cents(productPayload[findKey(['condition','18','price'])]);
        break;
      case 'CGC 10':
        if(findKey(['cgc','10','price'])) return cents(productPayload[findKey(['cgc','10','price'])]);
        if(findKey(['condition','17','price'])) return cents(productPayload[findKey(['condition','17','price'])]);
        break;
      case 'Graded 8':
        if(has('new-price')) return cents(productPayload['new-price']);
        if(findKey(['8','price'])) return cents(productPayload[findKey(['8','price'])]);
        break;
      case 'Graded 7':
        if(has('cib-price')) return cents(productPayload['cib-price']);
        if(findKey(['7','price'])) return cents(productPayload[findKey(['7','price'])]);
        break;
    }
    // Fallback preference order
    const fallbackOrder = ['graded-price','manual-only-price','loose-price','new-price','cib-price'];
    for(const k of fallbackOrder){ if(has(k)) return cents(productPayload[k]); }
    // Search any *-price
    const anyPriceKey = keys.find(k => /price$/i.test(k));
    return anyPriceKey ? cents(productPayload[anyPriceKey]) : 0;
  }

  // ====== RENDER ======
  function renderResults(list){
    const box = $('#results');
    box.innerHTML = '';
    if(!list.length){ box.innerHTML = '<div class="muted" style="padding:10px">No results yet. Try a broader search.</div>'; return; }
    list.forEach(p => {
      const el = document.createElement('div');
      el.className = 'result';
      el.innerHTML = `
        <div>
          <div><strong>${p['product-name']||'Unknown'}</strong></div>
          <small>${p['console-name']||''} • ID ${p.id}</small>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn pill" data-add="${p.id}">Add</button>
          <a class="btn pill ghost" target="_blank" rel="noreferrer" href="${API_BASE[state.source]}/item/${p.id}">Open</a>
        </div>
      `;
      box.appendChild(el);
    });
    // Bind add
    $$('#results [data-add]').forEach(btn => btn.addEventListener('click', async (e)=>{
      const id = e.currentTarget.getAttribute('data-add');
      e.currentTarget.textContent = 'Adding…';
      try {
        const payload = await apiGetProductById(id, state.source);
        state.priceCache[id] = payload; persistCache();
        addInventoryRowFromProduct(payload);
      } catch(err){ alert('Add failed: '+err.message); }
      finally { e.currentTarget.textContent = 'Add'; }
    }));
  }

  function renderTable(){
    const tbody = $('#tbody');
    tbody.innerHTML = '';
    state.items.forEach((row, idx) => {
      const priceC = pickPriceCents(state.priceCache[row.id]||{}, row.condition);
      const estValueC = cents(priceC * row.qty);
      const pnlC = cents(estValueC - (row.costCents||0) * row.qty);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><button class="pill" data-del="${idx}" title="Remove">✕</button></td>
        <td>
          <div style="font-weight:600">${row.name||''}</div>
          <div class="muted">ID ${row.id}</div>
        </td>
        <td>${row.set||''}</td>
        <td>
          <select data-cond="${idx}">
            ${CONDITION_OPTIONS.map(c => `<option ${c===row.condition?'selected':''}>${c}</option>`).join('')}
          </select>
        </td>
        <td><input class="row-input" type="number" min="1" step="1" value="${row.qty}" data-qty="${idx}" /></td>
        <td><input class="row-input" type="number" min="0" step="0.01" value="${(row.costCents||0)/100}" data-cost="${idx}" /></td>
        <td class="money">${fmt(priceC)}</td>
        <td class="money">${fmt(estValueC)}</td>
        <td class="money ${pnlC>=0? 'delta-pos':'delta-neg'}">${fmt(pnlC)}</td>
        <td><input class="row-input" type="text" value="${row.notes||''}" data-notes="${idx}" /></td>
        <td class="muted">${row.updated||''}</td>
      `;
      tbody.appendChild(tr);
    });

    // Bind events
    $$('#tbody [data-del]').forEach(btn => btn.addEventListener('click', (e)=>{
      const i = +e.currentTarget.getAttribute('data-del');
      state.items.splice(i,1); persist(); renderTable(); updateTotals();
    }));
    $$('#tbody [data-cond]').forEach(sel => sel.addEventListener('change', (e)=>{
      const i = +e.currentTarget.getAttribute('data-cond');
      state.items[i].condition = e.currentTarget.value; state.items[i].updated = nowStr();
      persist(); renderTable(); updateTotals();
    }));
    $$('#tbody [data-qty]').forEach(inp => inp.addEventListener('input', (e)=>{
      const i = +e.currentTarget.getAttribute('data-qty');
      state.items[i].qty = Math.max(1, parseInt(e.currentTarget.value||'1')); state.items[i].updated = nowStr();
      persist(); renderTable(); updateTotals();
    }));
    $$('#tbody [data-cost]').forEach(inp => inp.addEventListener('input', (e)=>{
      const i = +e.currentTarget.getAttribute('data-cost');
      state.items[i].costCents = moneyToCents(e.currentTarget.value||'0'); state.items[i].updated = nowStr();
      persist(); renderTable(); updateTotals();
    }));
    $$('#tbody [data-notes]').forEach(inp => inp.addEventListener('input', (e)=>{
      const i = +e.currentTarget.getAttribute('data-notes');
      state.items[i].notes = e.currentTarget.value; state.items[i].updated = nowStr();
      persist();
    }));
  }

  function updateTotals(){
    const totals = state.items.reduce((acc, row)=>{
      const priceC = pickPriceCents(state.priceCache[row.id]||{}, row.condition);
      acc.items += 1;
      acc.qty += row.qty;
      acc.valueC += cents(priceC * row.qty);
      acc.costC += cents((row.costCents||0) * row.qty);
      return acc;
    }, {items:0, qty:0, valueC:0, costC:0});
    $('#totalItems').textContent = totals.items;
    $('#totalQty').textContent = totals.qty;
    $('#totalValue').textContent = fmt(totals.valueC);
    $('#totalCost').textContent = fmt(totals.costC);
    const pnl = totals.valueC - totals.costC;
    $('#totalPnL').textContent = fmt(pnl);
    $('#totalPnL').className = 'money ' + (pnl>=0? 'delta-pos':'delta-neg');
  }

  function addInventoryRowFromProduct(p){
    const row = {
      id: p.id,
      name: p['product-name']||'Unknown',
      set: p['console-name']||'',
      condition: 'Ungraded',
      qty: 1,
      costCents: 0,
      notes: '',
      updated: nowStr()
    };
    state.items.unshift(row);
    persist(); renderTable(); updateTotals();
  }

  function persist(){
    localStorage.setItem('ct_items', JSON.stringify(state.items));
  }
  function persistCache(){
    localStorage.setItem('ct_priceCache', JSON.stringify(state.priceCache));
  }

  // ====== CSV IMPORT/EXPORT ======
  function exportCSV(){
    const header = ['id','name','set','condition','qty','unitCost','notes'];
    const rows = state.items.map(r => [r.id, r.name, r.set, r.condition, r.qty, (r.costCents||0)/100, r.notes||'']);
    const csv = Papa.unparse([header, ...rows]);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='cardtracker_inventory.csv'; a.click();
    URL.revokeObjectURL(url);
  }
  function exportJSON(){
    const json = JSON.stringify({source: state.source, items: state.items}, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='cardtracker_inventory.json'; a.click();
    URL.revokeObjectURL(url);
  }
  function downloadTemplate(){
    const header = ['id','name','set','condition','qty','unitCost','notes'];
    const sample = [
      ['72584','Michael Jordan #57','Basketball Cards 1986 Fleer','Ungraded','1','0','example note'],
    ];
    const csv = Papa.unparse([header, ...sample]);
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='cardtracker_template.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  function importCSVFile(file){
    Papa.parse(file, {
      header:true,
      skipEmptyLines:true,
      complete: (res)=>{
        const rows = res.data || [];
        const imported = [];
        rows.forEach(r => {
          if(!r.id) return; // require product id
          imported.push({
            id: String(r.id).trim(),
            name: (r.name||'').trim(),
            set: (r.set||'').trim(),
            condition: (r.condition||'Ungraded').trim(),
            qty: Math.max(1, parseInt(r.qty||'1')),
            costCents: moneyToCents(r.unitCost||'0'),
            notes: (r.notes||'').trim(),
            updated: nowStr()
          });
        });
        // Merge by id+notes (simple)
        state.items = [...imported, ...state.items];
        persist(); renderTable(); updateTotals();
        alert(`Imported ${imported.length} rows.`);
      }
    });
  }

  // ====== REFRESH PRICES ======
  async function refreshAllPrices(){
    const ids = [...new Set(state.items.map(r => r.id))];
    const queue = ids.filter(id => !state.priceCache[id]); // fetch missing first
    // also refresh all to be safe
    ids.forEach(id => { if(!queue.includes(id)) queue.push(id); });

    async function worker(){
      while(queue.length){
        const id = queue.shift();
        try{ const p = await apiGetProductById(id, state.source); state.priceCache[id] = p; persistCache(); }
        catch(err){ console.warn('Price refresh failed for id', id, err); }
        renderTable(); updateTotals();
        await new Promise(r => setTimeout(r, 250));
      }
    }
    const workers = Array.from({length: Math.min(3, queue.length)}, worker);
    await Promise.all(workers);
    alert('Prices refreshed.');
  }

  // ====== EVENT BINDINGS ======
  $('#btn-search').addEventListener('click', async ()=>{
    const q = $('#q').value.trim(); if(!q) return;
    $('#results').innerHTML = '<div class="muted" style="padding:10px">Searching…</div>';
    try{
      const list = await apiSearchProducts(q, state.source);
      renderResults(list);
    }catch(err){
      $('#results').innerHTML = `<div class="muted" style="padding:10px">Search error: ${err.message}</div>`;
    }
  });
  $('#q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('#btn-search').click(); });

  $('#btn-export').addEventListener('click', exportCSV);
  $('#btn-export-json').addEventListener('click', exportJSON);
  $('#btn-template').addEventListener('click', downloadTemplate);
  $('#btn-refresh').addEventListener('click', refreshAllPrices);
  $('#btn-clear').addEventListener('click', ()=>{
    if(confirm('Clear local inventory and cache?')){
      localStorage.removeItem('ct_items'); localStorage.removeItem('ct_priceCache');
      state.items = []; state.priceCache = {}; renderTable(); updateTotals();
    }
  });
  $('#btn-add-manual').addEventListener('click', ()=>{
    const id = prompt('Enter SportsCardsPro/PriceCharting product ID (numeric):');
    if(!id) return;
    apiGetProductById(id, state.source).then(payload => {
      state.priceCache[id] = payload; persistCache();
      addInventoryRowFromProduct(payload);
    }).catch(err=> alert('Lookup failed: '+err.message));
  });
  $('#source').value = state.source;
  $('#source').addEventListener('change', (e)=>{
    state.source = e.target.value; localStorage.setItem('ct_source', state.source);
    $('#results').innerHTML = '';
  });

  // Import CSV
  $('#btn-import input[type=file]').addEventListener('change', (e)=>{
    const f = e.target.files[0]; if(!f) return; importCSVFile(f); e.target.value = '';
  });

  // Initial render
  renderTable(); updateTotals();
  
  // Badge text
  $('#planTag').textContent = "API: Token";
  </script>

  <!-- ====================
       OPTIONAL: Netlify Function proxy (serverless)
       ————————————————
       Save the following as netlify/functions/scp.js and deploy. Then replace API calls above to hit
       /.netlify/functions/scp?path=/api/product&id=... and the function will inject the token securely.

       exports.handler = async (event) => {
         const token = process.env.SCP_TOKEN; // set in Netlify env
         const path = event.queryStringParameters.path || '/api/product';
         const id = event.queryStringParameters.id;
         const q = event.queryStringParameters.q;
         const source = event.queryStringParameters.source || 'scp';
         const base = source==='pc' ? 'https://www.pricecharting.com' : 'https://www.sportscardspro.com';
         const url = new URL(base + path);
         url.searchParams.set('t', token);
         if(id) url.searchParams.set('id', id);
         if(q) url.searchParams.set('q', q);
         const r = await fetch(url.toString());
         const data = await r.json();
         return { statusCode: 200, headers:{'content-type':'application/json','access-control-allow-origin':'*'}, body: JSON.stringify(data) };
       };
  ==================== -->

</body>
</html>
